{"version":3,"sources":["uni-app:///main.js","webpack:///C:/Users/will/Documents/GitHub/reference/GoEasy IM聊天和即时通讯示例/pages/chat/privateChat/privateChat.vue?c9e0","webpack:///C:/Users/will/Documents/GitHub/reference/GoEasy IM聊天和即时通讯示例/pages/chat/privateChat/privateChat.vue?d7d1","webpack:///C:/Users/will/Documents/GitHub/reference/GoEasy IM聊天和即时通讯示例/pages/chat/privateChat/privateChat.vue?a122","webpack:///C:/Users/will/Documents/GitHub/reference/GoEasy IM聊天和即时通讯示例/pages/chat/privateChat/privateChat.vue?8d8f","uni-app:///pages/chat/privateChat/privateChat.vue"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page"],"mappings":";;;;;;;;;;kDAAA;;;AAGA;AACA,mH,8FAHA;AACAA,EAAE,CAACC,iCAAH,GAAuCC,mBAAvC,CAGAC,UAAU,CAACC,oBAAD,CAAV,C;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAwH;AACxH;AAC+D;AACL;;;AAG1D;AACgM;AAChM,gBAAgB,2LAAU;AAC1B,EAAE,iFAAM;AACR,EAAE,sFAAM;AACR,EAAE,+FAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,0FAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACtBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA,aAAa,6OAEN;AACP,KAAK;AACL;AACA,aAAa,qNAEN;AACP;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AC5EA;AAAA;AAAA;AAAA;AAAyvB,CAAgB,2rBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC+G7wB;AACA,2F;AACA,+C;AACA;AACA,qBADA;AAEA;AACA,wCADA;AAEA,gCAFA,EAFA;;AAMA,MANA,kBAMA;AACA;AACA;AACA,+BADA;AAEA,8BAFA;AAGA,8BAHA;AAIA,8BAJA;AAKA,8BALA;AAMA,8BANA;;AAQA;AACA;AACA,iBAFA;AAGA,kBAHA;AAIA,uBAJA;AAKA;AACA,kBANA;AAOA;AACA,6BARA;;AAUA;AACA;AACA,qBADA;AAEA,qBAFA;AAGA,sBAHA;AAIA,8DAJA,EAXA;;AAiBA;AACA,0CAlBA;AAmBA;AACA,uBADA;AAEA;AACA,wBAHA;AAIA;AACA,sBALA,EAnBA;;;AA2BA;AACA,sBADA;AAEA,eAFA;AAGA,qBAHA,EA3BA;;AAgCA;AACA,qCAjCA;;AAmCA;AACA;AACA,sBADA;AAEA,qBAFA;AAGA,yBAHA,EApCA;;AAyCA;AACA;AACA,sBADA;AAEA,oBAFA,EA1CA;;;AA+CA,GA/DA;AAgEA,SAhEA,qBAgEA;AACA;AACA;AACA;AACA,6BADA;;AAGA,GAtEA;AAuEA,QAvEA,oBAuEA;AACA;AACA;AACA,GA1EA;AA2EA,QA3EA,kBA2EA,OA3EA,EA2EA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,GAvFA;AAwFA,mBAxFA,6BAwFA,CAxFA,EAwFA;AACA;AACA,GA1FA;AA2FA,UA3FA,sBA2FA;AACA;AACA;AACA;AACA,GA/FA;AAgGA;AACA;AACA;AACA,qBAHA,6BAGA,OAHA,EAGA;AACA;AACA,KALA;AAMA;AACA;AACA,qBARA,6BAQA,OARA,EAQA,KARA,EAQA;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAjBA;AAkBA,0BAlBA,oCAkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAZA;AAaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAVA;AAWA,OAZA;AAaA,KA/CA;AAgDA,yBAhDA,mCAgDA;AACA;AACA;AACA;AACA;AACA,OAHA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBADA;AAEA,2BAFA;AAGA,yBAHA;;AAKA;AACA;AACA;AACA;AACA;AACA,kCADA;AAEA,gDAFA;AAGA;AACA,sCADA;AAEA,0CAFA,EAHA,EADA;;;AASA,mBATA;AAUA;AACA;AACA,WAZA;AAaA;AACA,qDADA;AAEA,0BAFA,CAEA;AAFA,WAbA;;AAkBA;AACA,OAhCA;AAiCA;AACA;AACA;AACA;AACA;AACA,sBADA;AAEA,gCAFA;AAGA,wBAHA;;AAKA,OARA;AASA,KAlGA;AAmGA,eAnGA,uBAmGA,OAnGA,EAmGA;AACA;AACA;AACA;AACA,wBADA;AAEA;AACA;AACA,SAJA;AAKA;AACA;AACA;AACA,WAFA,MAEA;AACA;AACA;AACA,SAXA;;AAaA,KAnHA;AAoHA,qBApHA,+BAoHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BADA;AAEA;AACA,gCADA;AAEA,8CAFA;AAGA;AACA,oCADA;AAEA,wCAFA,EAHA,EAFA;;;AAUA;AACA,mDADA;AAEA,sBAFA,EAVA;;;AAeA;AACA;AACA;AACA,KA5IA;AA6IA,mBA7IA,2BA6IA,OA7IA,EA6IA;AACA,8CADA,CACA;AACA;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA;AACA;AACA,KAtJA;AAuJA,uBAvJA,iCAuJA;AACA;AACA,wBADA;AAEA;AACA;AACA;AACA;AACA;AACA,SAPA;;AASA,KAjKA;AAkKA,0BAlKA,oCAkKA;AACA;AACA;AACA,0BADA;AAEA;AACA;AACA;AACA;AACA;AACA,WAPA;;AASA;AACA,KA9KA;AA+KA,iBA/KA,2BA+KA;AACA;AACA,+CADA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,WALA;AAMA;AACA,SAVA;AAWA;AACA;AACA,SAbA;;AAeA,KA/LA;AAgMA,iBAhMA,2BAgMA;AACA;AACA;AACA,+CADA;AAEA;AACA;AACA,SAJA;AAKA;AACA;AACA,SAPA;;AASA,KA3MA;AA4MA,uBA5MA,+BA4MA,OA5MA,EA4MA;AACA;AACA;AACA;AACA;AACA,KAjNA;AAkNA,gBAlNA,0BAkNA;AACA;AACA;AACA;AACA,KAtNA;AAuNA,kBAvNA,0BAuNA,CAvNA,EAuNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAJA;AAKA;AACA,KAhOA;AAiOA,sBAjOA,8BAiOA,cAjOA,EAiOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCADA;AAEA,2CAFA;AAGA,iBAHA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA,WAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAlBA;AAmBA;AACA;AACA;AACA;AACA,SAvBA;;AAyBA,KAhQA;AAiQA;AACA,uBAlQA,iCAkQA;AACA;AACA;AACA;AACA,+BADA;AAEA;AACA;AACA,+BADA;AAEA,sCAFA;;AAIA,WAPA;;AASA;AACA,KA/QA;AAgRA,iBAhRA,2BAgRA;AACA;AACA;AACA,OAFA,CAEA;AACA;AACA,uBADA;AAEA,+EAFA;;AAIA;AACA,KAzRA;AA0RA,eA1RA,yBA0RA;AACA;AACA;AACA,OAFA,CAEA;AACA;AACA;AACA,KAhSA;AAiSA,sBAjSA,gCAiSA;AACA;AACA;AACA;AACA;AACA,oCADA;AAEA,kDAFA;AAGA;AACA,wCADA;AAEA,4CAFA,EAHA,EADA;;;AASA,qBATA;AAUA;AACA;AACA,aAZA;AAaA;AACA,uDADA;AAEA,4BAFA,CAEA;AAFA,aAbA;;AAkBA;AACA,SArBA;;AAuBA,KAzTA;AA0TA,sBA1TA,gCA0TA;AACA;AACA,gBADA;AAEA;AACA;AACA;AACA;AACA,sCADA;AAEA,oDAFA;AAGA;AACA,0CADA;AAEA,8CAFA,EAHA,EADA;;;AASA,wBATA;AAUA;AACA;AACA,eAZA;AAaA;AACA,yDADA;AAEA,8BAFA,CAEA;AAFA,eAbA;;AAkBA;AACA,WApBA;AAqBA,SAxBA;;AA0BA,KArVA;AAsVA,uBAtVA,+BAsVA,CAtVA,EAsVA;AACA;AACA;AACA,uBADA;;AAGA,KA3VA;AA4VA,aA5VA,qBA4VA,CA5VA,EA4VA;AACA;AACA;AACA;AACA;AACA,sBADA;;AAGA;AACA,OALA;AAMA,KArWA;AAsWA,2BAtWA,mCAsWA,CAtWA,EAsWA;AACA;AACA;AACA;AACA;AACA;AACA,KA5WA;AA6WA,uBA7WA,iCA6WA;AACA;AACA;AACA,KAhXA;AAiXA,aAjXA,uBAiXA;AACA;AACA;AACA,KApXA;AAqXA,8BArXA,wCAqXA;AACA;AACA;AACA,KAxXA;AAyXA,eAzXA,uBAyXA,QAzXA,EAyXA;AACA;AACA,KA3XA;AA4XA,uBA5XA,+BA4XA,IA5XA,EA4XA;AACA;AACA,qBADA;AAEA;AACA,6BADA;AAEA,2BAFA;AAGA,2BAHA,EAFA;;AAOA;AACA,8BADA;AAEA,4CAFA;AAGA;AACA,kCADA;AAEA,sCAFA,EAHA,EAPA;;;AAeA;AACA,iDADA;AAEA,wBAFA,CAEA;AAFA,SAfA;;AAoBA;AACA;AACA,KAnZA;AAoZA,yBApZA,mCAoZA;AACA;AACA,KAtZA;AAuZA,0BAvZA,oCAuZA;AACA;AACA,KAzZA;AA0ZA,kBA1ZA,4BA0ZA;AACA;AACA;AACA,4BADA;AAEA,qBAFA;;AAIA,OALA,EAKA,GALA;AAMA,KAjaA;AAkaA,4BAlaA,sCAkaA;AACA;AACA,gCADA;AAEA;AACA;AACA,SAJA;AAKA;AACA;AACA,SAPA;;AASA,KA5aA,EAhGA,E","file":"pages/chat/privateChat/privateChat.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/chat/privateChat/privateChat.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./privateChat.vue?vue&type=template&id=25fc77ae&\"\nvar renderjs\nimport script from \"./privateChat.vue?vue&type=script&lang=js&\"\nexport * from \"./privateChat.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/chat/privateChat/privateChat.vue\"\nexport default component.exports","export * from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--16-0!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./privateChat.vue?vue&type=template&id=25fc77ae&\"","var components\ntry {\n  components = {\n    GoEasyAudioPlayer: function() {\n      return import(\n        /* webpackChunkName: \"components/GoEasyAudioPlayer/GoEasyAudioPlayer\" */ \"@/components/GoEasyAudioPlayer/GoEasyAudioPlayer.vue\"\n      )\n    },\n    CustomMessage: function() {\n      return import(\n        /* webpackChunkName: \"components/CustomMessage/CustomMessage\" */ \"@/components/CustomMessage/CustomMessage.vue\"\n      )\n    }\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  var l0 = _vm.__map(_vm.messages, function(message, index) {\n    var $orig = _vm.__get_orig(message)\n\n    var m0 = _vm.renderMessageDate(message, index)\n    var g0 =\n      message.recalled && !(message.senderId !== _vm.currentUser.uuid)\n        ? message.type === \"text\" && Date.now() - message.timestamp < 60 * 1000\n        : null\n    var g1 = !message.recalled\n      ? _vm.messageSelector.messages.includes(message)\n      : null\n    var m1 =\n      !message.recalled && message.type === \"text\"\n        ? _vm.renderTextMessage(message)\n        : null\n    return {\n      $orig: $orig,\n      m0: m0,\n      g0: g0,\n      g1: g1,\n      m1: m1\n    }\n  })\n\n  if (!_vm._isMounted) {\n    _vm.e0 = function($event) {\n      _vm.actionPopup.visible = false\n    }\n  }\n\n  _vm.$mp.data = Object.assign(\n    {},\n    {\n      $root: {\n        l0: l0\n      }\n    }\n  )\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./privateChat.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./privateChat.vue?vue&type=script&lang=js&\"","<template>\r\n\t<view class=\"chatInterface\">\r\n\t\t<view class=\"scroll-view\">\r\n\t\t\t<view class=\"all-history-loaded\">\r\n\t\t\t\t{{allHistoryLoaded ? '已经没有更多的历史消息' : '下拉获取历史消息'}}\r\n\t\t\t</view>\r\n\t\t\t<checkbox-group @change=\"selectMessages\">\r\n\t\t\t\t<!--消息记录-->\r\n\t\t\t\t<view v-for=\"(message,index) in messages\" :key=\"message.messageId\">\r\n\t\t\t\t\t<!--时间显示，类似于微信，隔5分钟不发言，才显示时间-->\r\n\t\t\t\t\t<view class=\"time-lag\">\r\n\t\t\t\t\t\t{{renderMessageDate(message, index)}}\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"message-recalled\" v-if=\"message.recalled\">\r\n\t\t\t\t\t\t<view v-if=\"message.senderId !== currentUser.uuid\">{{friend.name}}撤回了一条消息</view>\r\n\t\t\t\t\t\t<view v-else class=\"message-recalled-self\">\r\n\t\t\t\t\t\t\t<view>你撤回了一条消息</view>\r\n\t\t\t\t\t\t\t<span v-if=\"message.type === 'text' && Date.now()-message.timestamp< 60 * 1000 \" @click=\"editRecalledMessage(message.payload.text)\">重新编辑</span>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"message-item\" v-else>\r\n\t\t\t\t\t\t<view class=\"message-item-checkbox\">\r\n\t\t\t\t\t\t\t<checkbox v-show=\"messageSelector.visible && message.status !== 'sending'\" :value=\"message.messageId\" :checked=\"messageSelector.messages.includes(message)\" />\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<view class=\"message-item-content\" :class=\"{'self' : message.senderId ===  currentUser.uuid}\">\r\n\t\t\t\t\t\t\t<view class=\"avatar\">\r\n\t\t\t\t\t\t\t\t<image :src=\"message.senderId === currentUser.uuid? currentUser.avatar : friend.avatar\"></image>\r\n\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t<view class=\"content\" @longpress=\"showActionPopup(message)\">\r\n\t\t\t\t\t\t\t\t<view class=\"message-payload\">\r\n\t\t\t\t\t\t\t\t\t<b class=\"pending\" v-if=\"message.status === 'sending'\"></b>\r\n\t\t\t\t\t\t\t\t\t<b class=\"send-fail\" v-if=\"message.status === 'fail'\"></b>\r\n\t\t\t\t\t\t\t\t\t<view v-if=\"message.type === 'text'\" v-html=\"renderTextMessage(message)\"></view>\r\n\t\t\t\t\t\t\t\t\t<image class=\"image-content\" v-if=\"message.type === 'image'\" :src=\"message.payload.url\" :data-url=\"message.payload.url\" @click=\"showImageFullScreen\" mode=\"widthFix\"></image>\r\n\t\t\t\t\t\t\t\t\t<view class=\"video-snapshot\"  v-if=\"message.type === 'video'\" :data-url=\"message.payload.video.url\" @click=\"playVideo\">\r\n\t\t\t\t\t\t\t\t\t\t<image :src=\"message.payload.thumbnail.url\" mode=\"aspectFit\"></image>\r\n\t\t\t\t\t\t\t\t\t\t<view class=\"video-play-icon\"></view>\r\n\t\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t\t\t<GoEasyAudioPlayer v-if=\"message.type ==='audio'\" :src=\"message.payload.url\" :duration=\"message.payload.duration\" />\r\n\t\t\t\t\t\t\t\t\t<view class=\"custom-message\" v-if=\"message.type === 'order'\">\r\n\t\t\t\t\t\t\t\t\t\t<view class=\"title\">\r\n\t\t\t\t\t\t\t\t\t\t\t<image src=\"../../../static/images/order.png\"></image>\r\n\t\t\t\t\t\t\t\t\t\t\t<text>自定义消息</text>\r\n\t\t\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t\t\t\t<view class=\"custom-message-item\">编号：{{message.payload.number}}</view>\r\n\t\t\t\t\t\t\t\t\t\t<view class=\"custom-message-item\">商品: {{message.payload.goods}}</view>\r\n\t\t\t\t\t\t\t\t\t\t<view class=\"custom-message-item\">金额: {{message.payload.price}}</view>\r\n\t\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t\t<view v-if=\"message.senderId === currentUser.uuid\" :class=\"message.read ?'message-read':'message-unread'\">\r\n\t\t\t\t\t\t\t\t\t<view v-if=\"message.status === 'success'\">{{message.read?'已读':'未读'}}</view>\r\n\t\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</checkbox-group>\r\n\t\t</view>\r\n\t\t<view class=\"action-box\" v-if=\"!videoPlayer.visible && !messageSelector.visible\">\r\n\t\t\t<view class=\"action-top\">\r\n\t\t\t\t<view :class=\"[audio.visible ? 'record-icon record-open':'record-icon']\" @click=\"switchAudioKeyboard\"></view>\r\n\t\t\t\t<view class=\"record-input\" @touchstart=\"onRecordStart\" @touchend=\"onRecordEnd\" v-if=\"audio.visible\" >{{audio.recording ? '松开发送' : '按住录音'}}</view>\r\n\t\t\t\t<view class=\"message-input\" v-else>\r\n\t\t\t\t\t<!-- GoEasyIM最大支持3k的文本消息，如需发送长文本，需调整输入框maxlength值 -->\r\n\t\t\t\t\t<input type=\"text\" maxlength=\"700\" placeholder=\"发送消息\" v-model=\"content\" @focus=\"messageInputFocusin\">\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"file-icon emoji-icon\" @click=\"showEmoji\"></view>\r\n\t\t\t\t<view class=\"file-icon more-icon\" @click=\"showOtherTypesMessagePanel\"></view>\r\n\t\t\t\t<span class=\"send-message-btn\" @click=\"createTextMessage\">发送</span>\r\n\t\t\t</view>\r\n\t\t\t<!--展示表情列表-->\r\n\t\t\t<view class=\"action-bottom action-bottom-emoji\" v-if=\"emoji.visible\">\r\n\t\t\t\t<image class=\"emoji-item\" v-for=\"(emojiItem, emojiKey, index) in emoji.map\" :key=\"index\" :src=\"emoji.url + emojiItem\" @click=\"chooseEmoji(emojiKey)\"></image>\r\n\t\t\t</view>\r\n\t\t\t<!--其他类型消息面板-->\r\n\t\t\t<view class=\"action-bottom\" v-if=\"otherTypesMessagePanelVisible\">\r\n\t\t\t\t<view class=\"more-item\" @click=\"createImageMessage\">\r\n\t\t\t\t\t<image src=\"../../../static/images/tupian.png\"></image>\r\n\t\t\t\t\t<text>图片</text>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"more-item\" @click=\"createVideoMessage\">\r\n\t\t\t\t\t<image src=\"../../../static/images/shipin.png\"></image>\r\n\t\t\t\t\t<text>视频</text>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"more-item\" @click=\"showCustomMessageForm\">\r\n\t\t\t\t\t<image src=\"../../../static/images/zidingyi.png\"></image>\r\n\t\t\t\t\t<text>自定义消息</text>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<view class=\"action-popup\" @touchmove.stop.prevent v-if=\"actionPopup.visible\">\r\n\t\t\t<view class=\"layer\"></view>\r\n\t\t\t<view class=\"action-box\">\r\n\t\t\t\t<view class=\"action-item\" @click=\"deleteSingleMessage\">删除</view>\r\n\t\t\t\t<view class=\"action-item\" v-if=\"actionPopup.recallable\" @click=\"recallMessage\">撤回</view>\r\n\t\t\t\t<view class=\"action-item\" @click=\"showCheckBox\">多选</view>\r\n\t\t\t\t<view class=\"action-item\" @click=\"actionPopup.visible = false\">取消</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<view class=\"messageSelector-box\" v-if=\"messageSelector.visible\">\r\n\t\t\t<image class=\"messageSelector-btn\" @click=\"deleteMultipleMessages\" src=\"/static/images/delete.png\"></image>\r\n\t\t</view>\r\n\t\t<view class=\"record-loading\" v-if=\"audio.recording\"></view>\r\n\t\t<video v-if=\"videoPlayer.visible\" :src=\"videoPlayer.url\" id=\"videoPlayer\" @fullscreenchange=\"onVideoFullScreenChange\"></video>\r\n\t\t<CustomMessage v-if=\"customMessageFormVisible\" @createCustomMessage=\"createCustomMessage\" @closeCustomMessageForm=\"closeCustomMessageForm\"></CustomMessage>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport GoEasyAudioPlayer from '../../../components/GoEasyAudioPlayer/GoEasyAudioPlayer';\r\n\timport CustomMessage from '../../../components/CustomMessage/CustomMessage';\r\n\timport EmojiDecoder from '../../../lib/EmojiDecoder';\r\n\timport restApi from '../../../lib/restapi';\r\n\tconst recorderManager = uni.getRecorderManager();\r\n\texport default {\r\n\t\tname: 'privateChat',\r\n\t\tcomponents : {\r\n\t\t\tGoEasyAudioPlayer,\r\n\t\t\tCustomMessage\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\tconst emojiUrl = 'https://imgcache.qq.com/open/qcloud/tim/assets/emoji/';\r\n\t\t\tconst emojiMap = {\r\n\t\t\t\t'[么么哒]': 'emoji_3@2x.png',\r\n\t\t\t\t'[乒乓]': 'emoji_4@2x.png',\r\n\t\t\t\t'[便便]': 'emoji_5@2x.png',\r\n\t\t\t\t'[信封]': 'emoji_6@2x.png',\r\n\t\t\t\t'[偷笑]': 'emoji_7@2x.png',\r\n\t\t\t\t'[傲慢]': 'emoji_8@2x.png'\r\n\t\t\t};\r\n\t\t\treturn {\r\n\t\t\t\t//聊天文本框\r\n\t\t\t\tcontent: '',\r\n\t\t\t\tfriend: null,\r\n\t\t\t\tcurrentUser: null,\r\n\t\t\t\t//消息记录\r\n\t\t\t\tmessages: [],\r\n\t\t\t\t//是否加载完所有历史消息\r\n\t\t\t\tallHistoryLoaded: false,\r\n\r\n\t\t\t\t//定义表情列表\r\n\t\t\t\temoji : {\r\n\t\t\t\t\turl : emojiUrl,\r\n\t\t\t\t\tmap : emojiMap,\r\n\t\t\t\t\tvisible: false,\r\n\t\t\t\t\tdecoder:  new EmojiDecoder(emojiUrl, emojiMap),\r\n\t\t\t\t},\r\n\t\t\t\t//是否展示‘其他消息类型面板’\r\n\t\t\t\totherTypesMessagePanelVisible: false,\r\n\t\t\t\taudio : {\r\n\t\t\t\t\tstartTime: null,\r\n\t\t\t\t\t//语音录音中\r\n\t\t\t\t\trecording : false,\r\n\t\t\t\t\t//录音按钮展示\r\n\t\t\t\t\tvisible : false\r\n\t\t\t\t},\r\n\r\n\t\t\t\tvideoPlayer : {\r\n\t\t\t\t\tvisible : false,\r\n\t\t\t\t\turl : '',\r\n\t\t\t\t\tcontext : null\r\n\t\t\t\t},\r\n\t\t\t\t// 展示自定义消息框\r\n\t\t\t\tcustomMessageFormVisible: false,\r\n\r\n\t\t\t\t// 展示消息删除弹出框\r\n\t\t\t\tactionPopup:{\r\n\t\t\t\t\tvisible: false,\r\n\t\t\t\t\tmessage: null,\r\n                    recallable: false,\r\n\t\t\t\t},\r\n\t\t\t\t// 消息选择\r\n\t\t\t\tmessageSelector: {\r\n\t\t\t\t\tvisible: false,\r\n\t\t\t\t\tmessages: []\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tonReady () {\r\n\t\t\tthis.videoPlayer.context = uni.createVideoContext('videoPlayer',this);\r\n\t\t\t// https://uniapp.dcloud.io/api/ui/navigationbar?id=setnavigationbartitle\r\n\t\t\tuni.setNavigationBarTitle({\r\n\t\t\t\ttitle : this.friend.name\r\n\t\t\t});\r\n\t\t},\r\n\t\tonShow () {\r\n\t\t\tthis.otherTypesMessagePanelVisible = false;\r\n\t\t\tthis.emoji.visible = false;\r\n\t\t},\r\n\t\tonLoad(options) {\r\n\t\t\t//聊天对象\r\n\t\t\tlet friendId = options.to;\r\n\t\t\tthis.currentUser = uni.getStorageSync('currentUser');\r\n\t\t\t//从服务器获取最新的好友信息\r\n\t\t\tthis.friend = restApi.findUserById(friendId);\r\n\r\n\t\t\tthis.initialGoEasyListeners();\r\n\t\t\tthis.loadHistoryMessage(true);\r\n\t\t\t// 录音监听器\r\n\t\t\tthis.initRecorderListeners();\r\n\r\n\t\t},\r\n\t\tonPullDownRefresh(e) {\r\n\t\t\tthis.loadHistoryMessage(false);\r\n\t\t},\r\n\t\tonUnload() {\r\n\t\t\t//退出聊天页面之前，清空监听器\r\n\t\t\tthis.goEasy.im.on(this.GoEasy.IM_EVENT.PRIVATE_MESSAGE_RECEIVED, ()=>{});\r\n\t\t\tthis.goEasy.im.on(this.GoEasy.IM_EVENT.MESSAGE_DELETED, ()=>{});\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\t//渲染文本消息，如果包含表情，替换为图片\r\n\t\t\t//todo:本不需要该方法，可以在标签里完成，但小程序有兼容性问题，被迫这样实现\r\n\t\t\trenderTextMessage(message) {\r\n\t\t\t\treturn '<span class=\"text-content\">' + this.emoji.decoder.decode(message.payload.text) + '</span>'\r\n\t\t\t},\r\n\t\t\t//像微信那样显示时间，如果有几分钟没发消息了，才显示时间\r\n\t\t\t//todo:本不需要该方法，可以在标签里完成，但小程序有兼容性问题，被迫这样实现\r\n\t\t\trenderMessageDate(message, index) {\r\n\t\t\t\tif (index === 0) {\r\n\t\t\t\t\treturn this.formatDate(message.timestamp)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (message.timestamp - this.messages[index - 1].timestamp > 5 * 60 * 1000) {\r\n\t\t\t\t\t\treturn this.formatDate(message.timestamp)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn '';\r\n\t\t\t},\r\n\t\t\tinitialGoEasyListeners() {\r\n\t\t\t\t// 监听私聊消息\r\n\t\t\t\tthis.goEasy.im.on(this.GoEasy.IM_EVENT.PRIVATE_MESSAGE_RECEIVED, (message) => {\r\n\t\t\t\t\tconsole.log('PRIVATE_MESSAGE_RECEIVED:', message);\r\n\t\t\t\t\tlet senderId = message.senderId;\r\n\t\t\t\t\tlet receiverId = message.receiverId;\r\n\t\t\t\t\tlet friendId = this.currentUser.uuid === senderId?receiverId:senderId;\r\n\t\t\t\t\tif (friendId === this.friend.uuid) {\r\n\t\t\t\t\t\tthis.messages.push(message);\r\n\t\t\t\t\t\t//聊天时，收到消息标记为已读\r\n\t\t\t\t\t\tthis.markPrivateMessageAsRead();\r\n\t\t\t\t\t\t//收到新消息，是滚动到最底部\r\n\t\t\t\t\t\tthis.scrollToBottom();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t//监听消息删除\r\n\t\t\t\tthis.goEasy.im.on(this.GoEasy.IM_EVENT.MESSAGE_DELETED,(deletedMessages) => {\r\n\t\t\t\t\tdeletedMessages.forEach(message => {\r\n\t\t\t\t\t\tlet senderId = message.senderId;\r\n\t\t\t\t\t\tlet receiverId = message.receiverId;\r\n\t\t\t\t\t\tlet friendId = this.currentUser.uuid === senderId?receiverId:senderId;\r\n\t\t\t\t\t\tif (friendId === this.friend.uuid) {\r\n\t\t\t\t\t\t\tlet index = this.messages.indexOf(message);\r\n\t\t\t\t\t\t\tif (index > -1) {\r\n\t\t\t\t\t\t\t\tthis.messages.splice(index, 1);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tinitRecorderListeners(){\r\n\t\t\t\t// 监听录音开始\r\n\t\t\t\trecorderManager.onStart(() => {\r\n\t\t\t\t\tthis.audio.recording = true;\r\n\t\t\t\t\tthis.audio.startTime = Date.now();\r\n\t\t\t\t});\r\n\t\t\t\t//录音结束后，发送\r\n\t\t\t\trecorderManager.onStop((res) => {\r\n\t\t\t\t\tlet endTime = Date.now();\r\n\t\t\t\t\tthis.audio.recording = false;\r\n\t\t\t\t\tlet duration = endTime - this.audio.startTime;\r\n\t\t\t\t\tif (duration < 1000) {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ticon: 'error',\r\n\t\t\t\t\t\t\ttitle: '录音时间太短',\r\n\t\t\t\t\t\t\tduration: 500\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tres.duration = duration;\r\n\t\t\t\t\tlet audioMessage = this.goEasy.im.createAudioMessage({\r\n\t\t\t\t\t\tto : {\r\n\t\t\t\t\t\t\tid : this.friend.uuid,\r\n\t\t\t\t\t\t\ttype : this.GoEasy.IM_SCENE.PRIVATE,\r\n\t\t\t\t\t\t\tdata : {\r\n\t\t\t\t\t\t\t\tname:this.friend.name,\r\n\t\t\t\t\t\t\t\tavatar:this.friend.avatar\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfile: res,\r\n\t\t\t\t\t\tonProgress :function (progress) {\r\n\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnotification : {\r\n\t\t\t\t\t\t\ttitle : this.currentUser.name + '发来一段语音',\r\n\t\t\t\t\t\t\tbody : '[语音消息]'\t\t// 字段最长 50 字符\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.sendMessage(audioMessage);\r\n\t\t\t\t});\r\n\t\t\t\t// 监听录音报错\r\n\t\t\t\trecorderManager.onError((res) =>{\r\n\t\t\t\t\tthis.audio.recording = false;\r\n\t\t\t\t\trecorderManager.stop();\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\ttitle: '录音失败,请检查麦克风权限',\r\n\t\t\t\t\t\tduration: 1000\r\n\t\t\t\t\t});\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tsendMessage(message){\r\n\t\t\t\tthis.messages.push(message);\r\n\t\t\t\tthis.scrollToBottom();\r\n\t\t\t\tthis.goEasy.im.sendMessage({\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tonSuccess: function (message) {\r\n\t\t\t\t\t\tconsole.log('发送成功.', message);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonFailed: function (error) {\r\n\t\t\t\t\t\tif(error.code === 507){\r\n\t\t\t\t\t\t\tconsole.log('发送语音/图片/视频/文件失败，没有配置OSS存储，详情参考：https://www.goeasy.io/cn/docs/goeasy-2.x/im/message/media/send-media-message.html');\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tconsole.log('发送失败:',error);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tcreateTextMessage() {\r\n\t\t\t\tif (this.content.trim() !== '') {\r\n\t\t\t\t\tlet body = this.content;\r\n\t\t\t\t\tif(this.content.length >= 50){\r\n\t\t\t\t\t\tbody = this.content.substring(0,30)+'...';\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlet textMessage = this.goEasy.im.createTextMessage({\r\n\t\t\t\t\t\ttext: this.content,\r\n\t\t\t\t\t\tto : {\r\n\t\t\t\t\t\t\tid : this.friend.uuid,\r\n\t\t\t\t\t\t\ttype : this.GoEasy.IM_SCENE.PRIVATE,\r\n\t\t\t\t\t\t\tdata : {\r\n\t\t\t\t\t\t\t\tname:this.friend.name,\r\n\t\t\t\t\t\t\t\tavatar:this.friend.avatar\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnotification : {\r\n\t\t\t\t\t\t\ttitle : this.currentUser.name + '发来一段文字',\r\n\t\t\t\t\t\t\tbody : body\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.sendMessage(textMessage);\r\n\t\t\t\t}\r\n\t\t\t\tthis.content = '';\r\n\t\t\t},\r\n\t\t\tshowActionPopup(message) {\r\n\t\t\t\tconst MAX_RECALLABLE_TIME = 3 * 60 * 1000; //3分钟以内的消息才可以撤回\r\n\t\t\t\tthis.messageSelector.messages = [message];\r\n\t\t\t\tif ((Date.now() - message.timestamp) < MAX_RECALLABLE_TIME && message.senderId === this.currentUser.uuid && message.status === 'success') {\r\n\t\t\t\t\tthis.actionPopup.recallable = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.actionPopup.recallable = false;\r\n\t\t\t\t}\r\n\t\t\t\tthis.actionPopup.visible = true;\r\n\t\t\t},\r\n\t\t\tdeleteSingleMessage(){\r\n\t\t\t\tuni.showModal({\r\n\t\t\t\t\tcontent: '确认删除？',\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tthis.actionPopup.visible = false;\r\n\t\t\t\t\t\tif (res.confirm) {\r\n\t\t\t\t\t\t\tthis.deleteMessage();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tdeleteMultipleMessages(){\r\n\t\t\t\tif (this.messageSelector.messages.length > 0) {\r\n\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\tcontent: '确认删除？',\r\n\t\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\t\tthis.messageSelector.visible = false;\r\n\t\t\t\t\t\t\tif (res.confirm) {\r\n\t\t\t\t\t\t\t\tthis.deleteMessage();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tdeleteMessage() {\r\n\t\t\t\tthis.goEasy.im.deleteMessage({\r\n\t\t\t\t\tmessages: this.messageSelector.messages,\r\n\t\t\t\t\tonSuccess: (result)=>{\r\n\t\t\t\t\t\tthis.messageSelector.messages.forEach(message => {\r\n\t\t\t\t\t\t\tlet index = this.messages.indexOf(message);\r\n\t\t\t\t\t\t\tif (index > -1) {\r\n\t\t\t\t\t\t\t\tthis.messages.splice(index, 1);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.messageSelector.messages = [];\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonFailed: (error) => {\r\n\t\t\t\t\t\tconsole.log('error:', error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\trecallMessage() {\r\n\t\t\t\tthis.actionPopup.visible = false;\r\n\t\t\t\tthis.goEasy.im.recallMessage({\r\n\t\t\t\t\tmessages: this.messageSelector.messages,\r\n\t\t\t\t\tonSuccess: ()=>{\r\n\t\t\t\t\t\tconsole.log('撤回成功');\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonFailed: (error) => {\r\n\t\t\t\t\t\tconsole.log('撤回失败,error:', error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\teditRecalledMessage (content) {\r\n\t\t\t\tif (this.audio.visible) {\r\n\t\t\t\t\tthis.audio.visible = false;\r\n\t\t\t\t}\r\n\t\t\t\tthis.content = content;\r\n\t\t\t},\r\n\t\t\tshowCheckBox () {\r\n\t\t\t\tthis.messageSelector.messages = [];\r\n\t\t\t\tthis.messageSelector.visible = true;\r\n\t\t\t\tthis.actionPopup.visible = false;\r\n\t\t\t},\r\n\t\t\tselectMessages (e) {\r\n\t\t\t\tconst selectedMessageIds = e.detail.value;\r\n\t\t\t\tlet selectedMessages = [];\r\n\t\t\t\tthis.messages.forEach(message => {\r\n\t\t\t\t\tif(selectedMessageIds.includes(message.messageId)){\r\n\t\t\t\t\t\tselectedMessages.push(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tthis.messageSelector.messages = selectedMessages;\r\n\t\t\t},\r\n\t\t\tloadHistoryMessage(scrollToBottom) {//历史消息\r\n\t\t\t\tlet lastMessageTimeStamp = null;\r\n\t\t\t\tlet lastMessage = this.messages[0];\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessageTimeStamp = lastMessage.timestamp;\r\n\t\t\t\t}\r\n\t\t\t\tthis.goEasy.im.history({\r\n\t\t\t\t\tuserId: this.friend.uuid,\r\n\t\t\t\t\tlastTimestamp: lastMessageTimeStamp,\r\n\t\t\t\t\tlimit: 10,\r\n\t\t\t\t\tonSuccess: (result) => {\r\n\t\t\t\t\t\tconsole.log(\"result:\", result);\r\n\t\t\t\t\t\tuni.stopPullDownRefresh();\r\n\t\t\t\t\t\tlet messages = result.content;\r\n\t\t\t\t\t\tif (messages.length === 0) {\r\n\t\t\t\t\t\t\tthis.allHistoryLoaded = true;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.messages = messages.concat(this.messages);\r\n\t\t\t\t\t\t\tif (scrollToBottom) {\r\n\t\t\t\t\t\t\t\tthis.scrollToBottom();\r\n\t\t\t\t\t\t\t\t//收到的消息设置为已读\r\n\t\t\t\t\t\t\t\tthis.markPrivateMessageAsRead();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonFailed: (error) => {\r\n\t\t\t\t\t\t//获取失败\r\n\t\t\t\t\t\tconsole.log('获取历史消息失败:',error);\r\n\t\t\t\t\t\tuni.stopPullDownRefresh();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\t//语音录制按钮和键盘输入的切换\r\n\t\t\tswitchAudioKeyboard() {\r\n\t\t\t\tthis.audio.visible = !this.audio.visible;\r\n\t\t\t\tif(uni.authorize){\r\n\t\t\t\t\tuni.authorize({\r\n\t\t\t\t\t\tscope : 'scope.record',\r\n\t\t\t\t\t\tfail: () => {\r\n\t\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\t\ttitle: '获取录音权限失败',\r\n\t\t\t\t\t\t\t\tcontent : '请先授权才能发送语音消息！'\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonRecordStart () {\r\n\t\t\t\ttry{\r\n\t\t\t\t\trecorderManager.start();\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\ttitle: '录音错误',\r\n\t\t\t\t\t\tcontent : '请在app和小程序端体验录音，Uni官方明确H5不支持getRecorderManager, 详情查看Uni官方文档'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonRecordEnd () {\r\n\t\t\t\ttry{\r\n\t\t\t\t\trecorderManager.stop();\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tconsole.log(e);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcreateVideoMessage () {\r\n\t\t\t\tuni.chooseVideo({\r\n\t\t\t\t\tsuccess : (res) => {\r\n\t\t\t\t\t\tlet videoMessage = this.goEasy.im.createVideoMessage({\r\n\t\t\t\t\t\t\tto : {\r\n\t\t\t\t\t\t\t\tid : this.friend.uuid,\r\n\t\t\t\t\t\t\t\ttype : this.GoEasy.IM_SCENE.PRIVATE,\r\n\t\t\t\t\t\t\t\tdata : {\r\n\t\t\t\t\t\t\t\t\tname:this.friend.name,\r\n\t\t\t\t\t\t\t\t\tavatar:this.friend.avatar\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tfile: res,\r\n\t\t\t\t\t\t\tonProgress :function (progress) {\r\n\t\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnotification : {\r\n\t\t\t\t\t\t\t\ttitle : this.currentUser.name + '发来一个视频',\r\n\t\t\t\t\t\t\t\tbody : '[视频消息]'\t\t// 字段最长 50 字符\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.sendMessage(videoMessage);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tcreateImageMessage() {\r\n\t\t\t\tuni.chooseImage({\r\n                    count : 9,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tres.tempFiles.forEach(file => {\r\n\t\t\t\t\t\t\tlet imageMessage = this.goEasy.im.createImageMessage({\r\n\t\t\t\t\t\t\t\tto : {\r\n\t\t\t\t\t\t\t\t\tid : this.friend.uuid,\r\n\t\t\t\t\t\t\t\t\ttype : this.GoEasy.IM_SCENE.PRIVATE,\r\n\t\t\t\t\t\t\t\t\tdata : {\r\n\t\t\t\t\t\t\t\t\t\tname:this.friend.name,\r\n\t\t\t\t\t\t\t\t\t\tavatar:this.friend.avatar\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tfile: file,\r\n\t\t\t\t\t\t\t\tonProgress :function (progress) {\r\n\t\t\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tnotification : {\r\n\t\t\t\t\t\t\t\t\ttitle : this.currentUser.name + '发来一张图片',\r\n\t\t\t\t\t\t\t\t\tbody : '[图片消息]'\t\t// 字段最长 50 字符\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tthis.sendMessage(imageMessage);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tshowImageFullScreen (e) {\r\n\t\t\t\tlet imagesUrl = [e.currentTarget.dataset.url];\r\n\t\t\t\tuni.previewImage({\r\n\t\t\t\t\turls: imagesUrl\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tplayVideo (e) {\r\n\t\t\t\tthis.videoPlayer.visible = true;\r\n\t\t\t\tthis.videoPlayer.url = e.currentTarget.dataset.url;\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\tthis.videoPlayer.context.requestFullScreen({\r\n\t\t\t\t\t\tdirection : 0\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.videoPlayer.context.play();\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tonVideoFullScreenChange (e) {\r\n\t\t\t\t//当退出全屏播放时，隐藏播放器\r\n\t\t\t\tif(this.videoPlayer.visible && !e.detail.fullScreen){\r\n\t\t\t\t    this.videoPlayer.visible = false;\r\n\t\t\t\t    this.videoPlayer.context.stop();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tmessageInputFocusin () {\r\n\t\t\t\tthis.otherTypesMessagePanelVisible = false;\r\n\t\t\t\tthis.emoji.visible = false;\r\n\t\t\t},\r\n\t\t\tshowEmoji () {\r\n\t\t\t\tthis.emoji.visible = !this.emoji.visible;\r\n\t\t\t\tthis.otherTypesMessagePanelVisible = false;\r\n\t\t\t},\r\n\t\t\tshowOtherTypesMessagePanel () {\r\n\t\t\t\tthis.otherTypesMessagePanelVisible = !this.otherTypesMessagePanelVisible;\r\n\t\t\t\tthis.emoji.visible = false;\r\n\t\t\t},\r\n\t\t\tchooseEmoji (emojiKey) {\r\n\t\t\t\tthis.content +=emojiKey;\r\n\t\t\t},\r\n\t\t\tcreateCustomMessage (data) {\r\n\t\t\t\tlet customMessage = this.goEasy.im.createCustomMessage({\r\n\t\t\t\t\ttype : 'order',\r\n\t\t\t\t\tpayload : {\r\n\t\t\t\t\t\tnumber : data.number,\r\n\t\t\t\t\t\tgoods : data.goods,\r\n\t\t\t\t\t\tprice : data.price\r\n\t\t\t\t\t},\r\n\t\t\t\t\tto : {\r\n\t\t\t\t\t\tid : this.friend.uuid,\r\n\t\t\t\t\t\ttype : this.GoEasy.IM_SCENE.PRIVATE,\r\n\t\t\t\t\t\tdata : {\r\n\t\t\t\t\t\t\tname : this.friend.name,\r\n\t\t\t\t\t\t\tavatar: this.friend.avatar\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tnotification : {\r\n\t\t\t\t\t\ttitle : this.currentUser.name + '发来一份订单',\r\n\t\t\t\t\t\tbody : '[订单消息]'     // 字段最长 50 字符\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tthis.sendMessage(customMessage);\r\n\t\t\t\tthis.customMessageFormVisible = false;\r\n\t\t\t},\r\n\t\t\tshowCustomMessageForm () {\r\n\t\t\t\tthis.customMessageFormVisible = true;\r\n\t\t\t},\r\n\t\t\tcloseCustomMessageForm () {\r\n\t\t\t\tthis.customMessageFormVisible = false;\r\n\t\t\t},\r\n\t\t\tscrollToBottom () {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tuni.pageScrollTo({\r\n\t\t\t\t\t\tscrollTop: 2000000,\r\n\t\t\t\t\t\tduration: 0\r\n\t\t\t\t\t})\r\n\t\t\t\t},500);\r\n\t\t\t},\r\n\t\t\tmarkPrivateMessageAsRead () {\r\n\t\t\t\tthis.goEasy.im.markPrivateMessageAsRead({\r\n\t\t\t\t\tuserId: this.friend.uuid,\r\n\t\t\t\t\tonSuccess: function () {\r\n\t\t\t\t\t\tconsole.log('标记私聊已读成功');\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonFailed: function (error) {\r\n\t\t\t\t\t\tconsole.log(\"标记私聊已读失败\",error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style >\r\n</style>\r\n"],"sourceRoot":""}