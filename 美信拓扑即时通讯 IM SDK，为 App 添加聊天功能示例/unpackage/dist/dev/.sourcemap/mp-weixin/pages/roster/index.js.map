{"version":3,"sources":["webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?fc2a","uni-app:///main.js","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?8c4d","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?f3a1","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?c36f","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?0cdd","uni-app:///pages/roster/index.vue","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?9a75","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?fbaa","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?3655","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?0db1","uni-app:///pages/roster/message/index.vue","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?ac37","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/message/index.vue?41a3","webpack:///C:/Users/will/Documents/GitHub/reference/美信拓扑即时通讯 IM SDK，为 App 添加聊天功能示例/pages/roster/index.vue?7bb2"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page"],"mappings":";;;;;;;;;AAAA;AACA,OAAO,KAAU,EAAE,kBAKd;;;;;;;;;;;;;kDCNL;;;AAGA;AACA,6F,8FAHA;AACAA,EAAE,CAACC,iCAAH,GAAuCC,mBAAvC,CAGAC,UAAU,CAACC,cAAD,CAAV,C;;;;;;;;;;;;;ACLA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAkH;AAClH;AACyD;AACL;AACa;;;AAGjE;AAC6L;AAC7L,gBAAgB,2LAAU;AAC1B,EAAE,2EAAM;AACR,EAAE,gFAAM;AACR,EAAE,yFAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,oFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAouB,CAAgB,qrBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACsCxvB;AACA,oF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAHA;AACA;eAIA,EACA,IADA,kBACA,CACA,SACA,YADA,EAEA,MAFA,EAGA,wBAHA,EAIA,aAJA,EAKA,cALA,EAMA,cANA,EAOA,UAPA,EAQA,KARA,EASA,YATA,EAUA,gBAVA,EAWA,iBAXA,EAYA,YAZA,EAaA,WAbA,EAcA,WAdA,EAeA,cAfA,GAiBA,CAnBA,EAqBA,cACA,uBADA,EArBA,EAwBA,SAxBA,EAyBA,2BACA,eACA,aADA,IAGA,CA7BA,EA8BA,+BACA,eACA,cADA,IAIA;AACA;AACA;AACA,6CADA;AAEA,iDAFA;AAGA,yDAHA;AAIA,uEAJA,GADA;;AAOA,GA3CA;AA4CA;AACA;AACA,wCADA;AAEA,oBAFA,IADA;;;AAMA,OANA,GAMA,OANA,CAMA,GANA,iBAMA,OANA,CAMA,IANA,CAMA,IANA,8BAMA,EANA;AAOA;AACA,kBADA;;;AAIA;AACA;AACA;AACA;AACA,0BADA;;AAGA;AACA;AACA,OAFA,EAEA,GAFA;AAGA;AACA,+CADA;AAEA,mDAFA;AAGA,2DAHA;AAIA,yEAJA;;AAMA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,0FADA;;AAGA;AACA;AACA,YADA;;AAGA,GApFA;AAqFA;AACA;AACA;AACA;AACA,KAJA;AAKA;AACA;AACA,KAPA;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,WADA;AAEA;AACA;AACA;AACA;AACA;AACA,SALA;AAMA,YANA,GAMA,OANA,CAMA,IANA,CAMA,EANA,GAMA,OANA,CAMA,EANA;AAOA;AACA;AACA;AACA;AACA,iBADA,CACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,SAHA,MAGA;AACA;AACA;AACA,SAHA,MAGA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,wCADA;;AAGA,KA7DA;;AA+DA,qBA/DA,6BA+DA,OA/DA,EA+DA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAtFA;;AAwFA,qBAxFA,oCAwFA;AACA;AACA;AACA,KA3FA;;AA6FA,eA7FA,uBA6FA,OA7FA,EA6FA;AACA,aADA,CACA,GADA,CACA,GADA,6BACA,EADA;;AAGA;AACA;;AAEA;AACA;AACA,SAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KA5GA;;AA8GA,UA9GA,oBA8GA;AACA;AACA;AACA,4BADA;;AAGA,KAnHA;;AAqHA,sBArHA,gCAqHA;AACA;;AAEA;AACA;AACA,0BADA;AAEA;AACA;AAHA;AAKA;AACA;AACA,0BADA;;AAGA,SAJA,EAIA,GAJA;AAKA;AACA,KApIA;;AAsIA,sBAtIA,8BAsIA,GAtIA,EAsIA;AACA;AACA;AACA,8BADA;;AAGA,KA3IA;;AA6IA,aA7IA,uBA6IA;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA,qCADA;;AAGA;AA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","file":"pages/roster/index.js","sourcesContent":["// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1667473764718\n      var cssReload = require(\"C:/Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"../../\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  ","import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/roster/index.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./index.vue?vue&type=template&id=1bd98647&\"\nvar renderjs\nimport script from \"./index.vue?vue&type=script&lang=js&\"\nexport * from \"./index.vue?vue&type=script&lang=js&\"\nimport style0 from \"./index.vue?vue&type=style&index=0&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/roster/index.vue\"\nexport default component.exports","export * from \"-!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--16-0!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=template&id=1bd98647&\"","var components\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=script&lang=js&\"","<template>\n  <view>\n    <snav :title=\"stitle\">\n      <view class=\"back\" @tap.stop=\"backClick\">\n        <image class=\"back_kmg\" src=\"/static/pages/image/back.png\"></image>\n      </view>\n      <view class=\"history_button\" @click=\"queryHistory()\">查看历史</view>\n      <view class=\"delete_button\" @click=\"deleteConversation()\">删除会话</view>\n    </snav>\n    <view class=\"container\" :style=\"'padding-top:' + navHeight + 'px'\">\n      <scroll-view class=\"contentcontainer\" :style=\"'height:' + wh + 'px'\" scroll-y :scroll-top=\"scrolltop\">\n        <block v-for=\"(message, index) in messages\" :key=\"index\">\n          <message :message=\"message\"></message>\n        </block>\n      </scroll-view>\n      <view class=\"inputer\">\n        <image class=\"voice\" src=\"/static/pages/image/voice.png\" @tap=\"voiceHandler\"></image>\n        <input\n          v-if=\"!showvoice\"\n          @input=\"inputChangeHandler\"\n          placeholder=\"type a message!\"\n          class=\"input\"\n          type=\"text\"\n          confirm-type=\"send\"\n          @confirm=\"sendMessageHandler\"\n          :value=\"inputValue\"\n        />\n        <view v-else class=\"recorder\" @touchstart=\"startRecord\" @touchend=\"stopRecord\">\n          <text>{{ recordTxt }}</text>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script>\n//index.js\n//获取应用实例\nimport { toLong, toNumber } from '../../third/tools';\nimport message from './message/index';\n\nexport default {\n  data() {\n    return {\n      messages: [],\n      uid: 0,\n      queryHistoryMessageId: 0,\n      scrolltop: -1,\n      inputValue: '',\n      showing: false,\n      stitle: '',\n      wh: 0,\n      navHeight: 0,\n      showvoice: false,\n      recordTxt: '按下录音',\n      startTime: 0,\n      duration: 0,\n      timer: null,\n      recordFile: ''\n    };\n  },\n\n  components: {\n    message\n  },\n  props: {},\n  onShow: function () {\n    this.setData({\n      showing: true\n    });\n  },\n  onUnload: function () {\n    this.setData({\n      showing: false\n    });\n\n    const im = getApp().getIM();\n    im &&\n      im.off({\n        onRosterMessage: this.receiveNewMessage,\n        onReceiveHistoryMsg: this.receiveHistoryMsg,\n        onMessageStatusChanged: this.onMessageStatusChanged,\n        onSendingMessageStatusChanged: this.onSendingMessageStatusChanged\n      });\n  },\n  onLoad: function (options) {\n    this.setData({\n      navHeight: getApp().getNavHeight(),\n      showing: false\n    });\n\n    let { uid, nick = '' } = options;\n    this.setData({\n      uid: uid - 0\n    });\n\n    const im = getApp().getIM();\n    if (im) {\n      const messages = im.rosterManage.getRosterMessageByRid(uid - 0);\n      this.appendMessage({\n        messages\n      });\n      setTimeout(() => {\n        this.scroll();\n      }, 500);\n      im.on({\n        onRosterMessage: this.receiveNewMessage,\n        onReceiveHistoryMsg: this.receiveHistoryMsg,\n        onMessageStatusChanged: this.onMessageStatusChanged,\n        onSendingMessageStatusChanged: this.onSendingMessageStatusChanged\n      });\n    }\n\n    /** 设置title */\n\n    const umaps = im.rosterManage.getAllRosterDetail();\n    let fromUserObj = umaps[uid] || { user_id: uid };\n    if (uid == 0) fromUserObj.username = '系统通知';\n    this.setData({\n      stitle: nick || fromUserObj.nick_name || fromUserObj.username || fromUserObj.user_id\n    });\n    const wh = wx.getSystemInfoSync().windowHeight - this.navHeight - 70;\n    this.setData({\n      wh\n    });\n  },\n  methods: {\n    onMessageStatusChanged: ({ mid }) => {\n      console.log('Message status changed, mid: ', mid);\n      //TODO: refresh page\n    },\n    onSendingMessageStatusChanged: ({ status, mid }) => {\n      console.log('Sending Message status changed to ', status, ' mid: ', mid);\n    },\n\n    appendMessage: function (data) {\n      const newMessages = data.messages || [];\n      const isHistory = data.history;\n      if (isHistory) {\n        this.queryHistoryMessageId = data.next;\n      }\n      const uid = getApp().getIM().userManage.getUid();\n      const oldMessages = this.messages || [];\n\n      let allMessages = [];\n      let i = 0,\n        j = 0;\n      while (i < newMessages.length && j < oldMessages.length) {\n        const newMeta = newMessages[i];\n        if (newMeta.ext && newMeta.ext.input_status) {\n          i++;\n          continue;\n        }\n        const { from, to } = newMeta;\n        const fromUid = toNumber(from);\n        const toUid = toNumber(to);\n        let saveUid = fromUid === uid ? toUid : fromUid;\n        if (saveUid + '' !== this.uid + '') {\n          return; // rosterchat, 必须有一个id是 sid\n        }\n\n        const oldMeta = oldMessages[j];\n        const c = toLong(newMeta.id).comp(toLong(oldMeta.id));\n        if (-1 === c) {\n          allMessages.push(newMeta);\n          i++;\n        } else if (1 === c) {\n          allMessages.push(oldMeta);\n          j++;\n        } else {\n          //same id, which means message info updated\n          allMessages.push(newMeta);\n          i++;\n          j++;\n        }\n      }\n\n      if (i < newMessages.length) {\n        allMessages = allMessages.concat(newMessages.slice(i, newMessages.length));\n      }\n\n      if (j < oldMessages.length) {\n        allMessages = allMessages.concat(oldMessages.slice(i, oldMessages.length));\n      }\n      this.setData({\n        messages: [].concat(allMessages)\n      });\n    },\n\n    receiveNewMessage(message) {\n      const im = getApp().getIM();\n      if (!im) return;\n\n      const uid = im.userManage.getUid();\n      const to = message.to;\n      const from = message.from;\n      const pid = this.uid;\n\n      if ((uid == to && from == pid) || (uid == from && to == pid)) {\n        if (!this.checkTyping(message)) {\n          // we might reload all messages because of message operations, which could be message deletion;\n          // const smessages = im.rosterManage.getRosterMessageByRid(this.uid - 0);\n          console.log('Got: ', message);\n          this.appendMessage({ messages: [message] });\n          this.scroll();\n        }\n      }\n\n      if (this.showing && from !== uid) {\n        //do not read message sent by oneself\n        im.rosterManage.readRosterMessage(this.uid, message.id);\n      }\n    },\n\n    receiveHistoryMsg({ next }) {\n      this.setData({ queryHistoryMessageId: next });\n      this.scroll();\n    },\n\n    checkTyping(message) {\n      const { ext = {} } = message;\n\n      if (typeof ext.input_status !== 'undefined') {\n        let status = ext.input_status;\n\n        if (status == 'nothing') {\n          // this.header.querySelector(\".typing\").style.display = \"none\";\n        } else {\n          // this.header.querySelector(\".typing\").style.display = \"inline\";\n          // this.header.querySelector(\".typing\").innerHTML = status + \"...\";\n        }\n        return true;\n      }\n      return false;\n    },\n\n    scroll() {\n      const scrolltop = this.messages.length * 1000;\n      this.setData({\n        scrolltop\n      });\n    },\n\n    sendMessageHandler() {\n      const content = this.inputValue;\n\n      if (content) {\n        getApp().getIM().sysManage.sendRosterMessage({\n          content,\n          uid: this.uid\n          // ext: \"自定义消息字段\",\n        });\n        setTimeout(() => {\n          this.setData({\n            inputValue: ''\n          });\n        }, 400);\n      }\n    },\n\n    inputChangeHandler(evt) {\n      const inputValue = (evt.detail && evt.detail.value) || '';\n      this.setData({\n        inputValue\n      });\n    },\n\n    backClick() {\n      if (getCurrentPages().length > 1) {\n        wx.navigateBack();\n      } else {\n        wx.switchTab({\n          url: '/pages/contact/index'\n        });\n      }\n    },\n\n    queryHistory() {\n      const im = getApp().getIM();\n      if (!im) return;\n\n      // Query historys older than the message with id:mid, 0 means from the last message;\n      const mid = this.queryHistoryMessageId;\n      const amount = 20; // Batch size of one time history message query.\n      im.sysManage.requireHistoryMessage(this.uid, mid, amount);\n    },\n\n    deleteConversation() {\n      const also_delete_other_devices = true;\n      getApp().getIM().sysManage.deleteConversation(this.uid, also_delete_other_devices);\n      this.backClick();\n    },\n\n    voiceHandler() {\n      this.setData({\n        showvoice: !this.showvoice\n      });\n    },\n\n    startRecord() {\n      wx.authorize({\n        scope: 'scope.record',\n        success: function () {\n          console.log('录音授权成功');\n        },\n        fail: function () {\n          console.log('录音授权失败');\n        }\n      });\n      var that = this;\n      const recorderManager = wx.getRecorderManager();\n      recorderManager.onError((res) => {\n        console.log('录音错误: ', res);\n      });\n      recorderManager.onStop(function (res) {\n        that.setData({\n          recordFile: res.tempFilePath,\n          duration: Math.ceil((new Date().getTime() - that.startTime) / 1000)\n        });\n        console.log('录音完成: ', that.recordFile);\n        that.uploadVoice(that.recordFile);\n      });\n      const options = {\n        sampleRate: 44100,\n        numberOfChannels: 1,\n        encodeBitRate: 192000,\n        format: 'mp3'\n      };\n      recorderManager.start(options);\n      this.setData({\n        startTime: new Date().getTime(),\n        recordTxt: '录音中'\n      });\n      const timer = setTimeout(() => {\n        this.stopRecord();\n      }, 30000);\n      this.setData({\n        timer\n      });\n    },\n\n    stopRecord() {\n      if (this.timer) {\n        clearTimeout(this.timer);\n        this.setData({\n          timer: null\n        });\n      }\n\n      const recorderManager = wx.getRecorderManager();\n      recorderManager.stop();\n      this.setData({\n        recordTxt: '按下录音'\n      });\n    },\n\n    uploadVoice(path) {\n      const that = this;\n      const im = getApp().getIM();\n      im.sysManage\n        .asyncFileUpload({\n          file: path,\n          to_id: this.uid,\n          fileType: 'audio-mp3',\n          toType: 'chat',\n          chatType: 'roster'\n        })\n        .then((res) => {\n          console.log('录音上传成功');\n          that.sendVoiceMessage(res.url);\n        })\n        .catch((err) => {\n          console.log('录音发送失败：' + err);\n        });\n    },\n\n    sendVoiceMessage(url) {\n      const im = getApp().getIM();\n      const fileInfo = {\n        dName: 'file',\n        url,\n        duration: this.duration\n      };\n      im.sysManage.sendRosterMessage({\n        type: 'audio',\n        uid: this.uid,\n        content: '',\n        attachment: fileInfo\n      });\n    }\n  }\n};\n</script>\n<style>\n@import './index.css';\n</style>\n","import { render, staticRenderFns, recyclableRender, components } from \"./index.vue?vue&type=template&id=00c2013f&\"\nvar renderjs\nimport script from \"./index.vue?vue&type=script&lang=js&\"\nexport * from \"./index.vue?vue&type=script&lang=js&\"\nimport style0 from \"./index.vue?vue&type=style&index=0&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/roster/message/index.vue\"\nexport default component.exports","export * from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--16-0!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=template&id=00c2013f&\"","var components\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=script&lang=js&\"","<template>\n  <!-- index.wxml -->\n  <view>\n    <view class=\"time\">\n      <text>{{ time }}</text>\n    </view>\n    <view class=\"msgcontainer\">\n      <view :class=\"cls\">\n        <view class=\"rosterInfo\">\n          <image class=\"avatar\" :src=\"avatar\" @tap=\"goUserProfile\"></image>\n        </view>\n        <view class=\"c_content\">\n          <text v-if=\"type == 'text'\">\n            {{ content }}\n            <br />\n            <text v-if=\"ext\">ext: {{ ext }}</text>\n          </text>\n          <image class=\"cimage\" v-if=\"type == 'image'\" :src=\"attachImage\"></image>\n          <video class=\"cimage\" v-if=\"type == 'video'\" :src=\"video\"></video>\n          <!-- <audio name=\"音频文件\" wx:if=\"{{type == 'audio'}}\" author=\"\" src=\"{{audio}}\" class=\"saudio\" controls></audio> -->\n          <view class=\"voice_frmae\" v-if=\"type == 'audio'\" @tap=\"splayAudio\">\n            <image class=\"voice\" v-if=\"playing == false\" src=\"/static/pages/image/voice/stop.png\"></image>\n            <image class=\"voice\" v-if=\"playing == true\" src=\"/static/pages/image/voice/start.png\"></image>\n            <text class=\"voice_duration\">'{{ attach.duration }}</text>\n          </view>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script>\n//index.js\n//获取应用实例\nimport { toNumber, numToString } from '../../../third/tools';\nimport moment from '../../../third/moment';\n\nexport default {\n  data() {\n    return {\n      cls: '',\n      username: '',\n      avatar: '',\n      audio: '',\n      contentType: 0,\n      content: '',\n      ext: '',\n      attachImage: '',\n      videoCover: '',\n      video: '',\n      messageType: 0,\n      time: '',\n      playing: false,\n      from: '',\n      attach: '',\n      type: '',\n      toType: ''\n    };\n  },\n\n  components: {},\n  props: {\n    message: {\n      type: Object,\n      // 类型（必填），目前接受的类型包括：String, Number, Boolean, Object, Array, null（表示任意类型）\n      default: () => ({})\n    }\n  },\n  beforeMount: function () {\n    const message = this.message;\n    const im = getApp().getIM(); // FIXME: check im undefined\n    const uid = im.userManage.getUid();\n    const from = message.from;\n    const cls = uid == from ? 'self' : 'roster';\n    const type = message.type;\n    const toType = message.toType;\n    let content = message.content || '';\n    let ext = message.ext || '';\n    let username = '';\n    const fromUserObj = im.rosterManage.getRosterInfo(from);\n\n    if (from == 0) {\n      // system message\n      fromUserObj.username = '系统通知';\n      fromUserObj.avatar = '/static/pages/image/tab/setting.png';\n    }\n\n    let avatar = im.sysManage.getImage({\n      avatar: fromUserObj.avatar,\n      sdefault: '/static/pages/image/r.png'\n    });\n    username = fromUserObj.nick_name || fromUserObj.username || '';\n\n    if (from == uid) {\n      username = '我';\n    }\n\n    const attach = message.attach || {};\n    let url = attach.url || '';\n\n    if (url && type === 'image') {\n      url = im.sysManage.getImage({\n        avatar: url\n      });\n    }\n\n    let videoCover = '';\n    if (url && type === 'video') {\n      let tUrl = attach.tUrl || '';\n      videoCover = im.sysManage.getImage({\n        avatar: tUrl,\n        thumbnail: true\n      });\n      url = im.sysManage.getChatFile({ url });\n    }\n\n    if (url && type === 'audio') {\n      // 1. use the audio url;\n      let audio = im.sysManage.getAudio({\n        url\n      });\n      console.log('getAudio: ', audio);\n      this.setData({\n        audio\n      }); // 2. download audio to local file\n      // const that = this;\n      // im.sysManage.downloadAudio({url}).then((res) => {\n      //   console.log(\"getAudio: \", res);\n      //   that.setData({\n      //     audio: res,\n      //   });\n      // }).catch((ex) => {\n      //   console.error(\"getAudio error: \", ex);\n      // });\n    }\n\n    let { timestamp } = message;\n    timestamp = toNumber(timestamp);\n    let time = moment(timestamp).calendar('', {\n      sameDay: '[今天] HH:mm',\n      lastDay: '[昨天] HH:mm',\n      sameElse: 'YYYY-MM-DD HH:mm'\n    });\n    this.setData({\n      attach,\n      cls,\n      username,\n      avatar,\n      type,\n      toType,\n      content,\n      ext,\n      attachImage: url,\n      videoCover,\n      video: url,\n      time,\n      from\n    });\n  },\n\n  onShow: function () {\n    const im = getApp().getIM();\n    const message = this.message;\n\n    // Message displayed as read\n    const uid = im.userManage.getUid();\n    const fromUid = toNumber(this.message.from);\n    if (fromUid !== uid && message.status !== 'read') {\n      //do not read message sent by oneself\n      im.rosterManage.readRosterMessage(this.uid, message.id);\n    }\n  },\n  methods: {\n    splayAudio: function () {\n      const innerAudioContext = wx.createInnerAudioContext(); // innerAudioContext.autoplay = true\n\n      innerAudioContext.obeyMuteSwitch = false;\n      innerAudioContext.loop = false;\n      innerAudioContext.src = this.audio;\n      console.log('Play audio: ', this.audio);\n      this.setData({\n        playing: true\n      });\n      innerAudioContext.onPlay(() => {\n        setTimeout(() => {\n          innerAudioContext.stop();\n        }, (this.attach.duration + 3) * 1000);\n      });\n      innerAudioContext.onError((res) => {\n        console.error(\"Can't play audio due to \", res);\n        console.error('Play audio error: ', this.audio);\n        this.setData({\n          playing: false\n        });\n      });\n      innerAudioContext.onStop((res) => {\n        this.setData({\n          playing: false\n        });\n      });\n      innerAudioContext.play();\n    },\n\n    messageStatus() {\n      const im = getApp().getIM();\n\n      const fromUid = toNumber(this.message.from);\n      const toUid = toNumber(this.message.to);\n      const uid = im.userManage.getUid();\n      const cid = fromUid === uid ? toUid : fromUid;\n\n      // status will be unread / delivered / read\n      return im.sysManage.getMessageStatus(cid, this.message.id);\n    },\n\n    goUserProfile() {\n      if (this.cls == 'roster') {\n        wx.navigateTo({\n          url: '/pages/profile/userinfo/index?uid=' + this.from\n        });\n      }\n    }\n  }\n};\n</script>\n<style>\n@import './index.css';\n</style>\n","import mod from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=style&index=0&lang=css&\"; export default mod; export * from \"-!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=style&index=0&lang=css&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1667473764747\n      var cssReload = require(\"C:/Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"../../\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  ","import mod from \"-!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=style&index=0&lang=css&\"; export default mod; export * from \"-!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../../../Program Files/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./index.vue?vue&type=style&index=0&lang=css&\""],"sourceRoot":""}